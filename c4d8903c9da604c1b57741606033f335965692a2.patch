From c4d8903c9da604c1b57741606033f335965692a2 Mon Sep 17 00:00:00 2001
From: Andreas Schneider <asn@cryptomilk.org>
Date: Fri, 30 Jan 2015 13:06:39 +0000
Subject: WIP: init: Fix USB OTG Storage.

---
diff --git a/overlay/frameworks/base/core/res/res/xml/storage_list.xml b/overlay/frameworks/base/core/res/res/xml/storage_list.xml
index 3412e1a..35b8b52 100644
--- a/overlay/frameworks/base/core/res/res/xml/storage_list.xml
+++ b/overlay/frameworks/base/core/res/res/xml/storage_list.xml
@@ -1,19 +1,56 @@
 <?xml version="1.0" encoding="utf-8"?>
-<StorageList
-  xmlns:android="http://schemas.android.com/apk/res/android">
-  <storage android:mountPoint="/storage/sdcard0"
-      android:storageDescription="@string/storage_internal"
-      android:primary="true"
-      android:emulated="true"
-      android:mtpReserve="100" />
-
-  <storage android:mountPoint="/storage/Private"
-      android:storageDescription="@string/storage_sd_card"
-      android:primary="false"
-      android:removable="false" />
-
-  <storage android:mountPoint="/storage/usbstorage"
-      android:storageDescription="@string/storage_usb"
-      android:primary="false"
-      android:removable="true" />
+<!--
+
+  Copyright 2015, The Android Open Source Project
+
+  Licensed under the Apache License, Version 2.0 (the "License")
+  you may not use this file except in compliance with the License.
+  You may obtain a copy of the License at
+
+      http://www.apache.org/licenses/LICENSE-2.0
+
+  Unless required by applicable law or agreed to in writing, software
+  distributed under the License is distributed on an "AS IS" BASIS,
+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  See the License for the specific language governing permissions and
+  limitations under the License.
+
+-->
+
+<!-- The <device> element should contain one or more <storage> elements.
+     Exactly one of these should have the attribute primary="true".
+     This storage will be the primary external storage and should have mountPoint="/mnt/sdcard".
+     Each storage should have both a mountPoint and storageDescription attribute.
+     The following attributes are optional:
+
+        primary:    (boolean) this storage is the primary external storage
+        removable:  (boolean) this is removable storage (for example, a real SD card)
+        emulated:   (boolean) the storage is emulated via the FUSE sdcard daemon
+        mtpReserve: (integer) number of megabytes of storage MTP should reserve for free storage
+                     (used for emulated storage that is shared with system's data partition)
+
+      A storage should not have both emulated and removable set to true
+-->
+
+<StorageList xmlns:android="http://schemas.android.com/apk/res/android">
+
+    <!-- internal emulated storage -->
+    <storage android:mountPoint="/storage/sdcard0"
+             android:storageDescription="@string/storage_internal"
+             android:emulated="true"
+             android:primary="true"
+             android:mtpReserve="128" />
+
+    <!-- internal private storage -->
+    <storage android:mountPoint="/storage/Private"
+             android:storageDescription="@string/storage_sd_card"
+             android:primary="false"
+             android:removable="false" />
+
+    <!-- external usb storage -->
+    <storage android:mountPoint="/storage/usbdisk"
+             android:storageDescription="@string/storage_usb"
+             android:primary="false"
+             android:removable="true" />
+
 </StorageList>
diff --git a/ramdisk/fstab.universal5430 b/ramdisk/fstab.universal5430
index 95e7154..90d2aec 100644
--- a/ramdisk/fstab.universal5430
+++ b/ramdisk/fstab.universal5430
@@ -9,12 +9,5 @@
 /dev/block/mmcblk0p19    /cache              ext4      nosuid,nodev,noatime,noauto_da_alloc,discard,journal_async_commit,errors=panic    wait,check
 /dev/block/mmcblk0p21    /data               ext4      nosuid,nodev,noatime,noauto_da_alloc,discard,journal_async_commit,errors=panic    wait,check,encryptable=footer
 
-
 # VOLD
-/devices/platform/exynos-dwc3.0/exynos-xhci/usb*sda,/devices/15400000.usb/15400000.dwc3/xhci-hcd.2.auto/usb*sda            auto                    vfat    default     voldmanaged=UsbDriveA:auto
-/devices/platform/exynos-dwc3.0/exynos-xhci/usb*sdb,/devices/15400000.usb/15400000.dwc3/xhci-hcd.2.auto/usb*sdb            auto                    vfat    default     voldmanaged=UsbDriveB:auto
-/devices/platform/exynos-dwc3.0/exynos-xhci/usb*sdc,/devices/15400000.usb/15400000.dwc3/xhci-hcd.2.auto/usb*sdc            auto                    vfat    default     voldmanaged=UsbDriveC:auto
-/devices/platform/exynos-dwc3.0/exynos-xhci/usb*sdd,/devices/15400000.usb/15400000.dwc3/xhci-hcd.2.auto/usb*sdd            auto                    vfat    default     voldmanaged=UsbDriveD:auto
-/devices/platform/exynos-dwc3.0/exynos-xhci/usb*sde,/devices/15400000.usb/15400000.dwc3/xhci-hcd.2.auto/usb*sde            auto                    vfat    default     voldmanaged=UsbDriveE:auto
-/devices/platform/exynos-dwc3.0/exynos-xhci/usb*sdf,/devices/15400000.usb/15400000.dwc3/xhci-hcd.2.auto/usb*sdf           auto                    vfat    default     voldmanaged=UsbDriveF:auto
-
+/devices/platform/exynos-dwc3.0/exynos-xhci/usb*sda,/devices/15400000.usb/15400000.dwc3/xhci-hcd.2.auto/usb*sda            auto                    auto    defaults    voldmanaged=usbdisk:auto
diff --git a/ramdisk/init.universal5430.rc b/ramdisk/init.universal5430.rc
index 1a826ca..4300f83 100755
--- a/ramdisk/init.universal5430.rc
+++ b/ramdisk/init.universal5430.rc
@@ -989,7 +989,6 @@ service sdcard /system/bin/sdcard -u 1023 -g 1023 -l /data/media /mnt/shell/emul
 service fuse_usbdisk /system/bin/sdcard -u 1023 -g 1023 -w 1023 -d /mnt/media_rw/usbdisk /storage/usbdisk
     class late_start
     disabled
-    oneshot
 
 # Set watchdog timer to 30 seconds and pet it every 10 seconds to get a 20 second margin
 service watchdogd /sbin/watchdogd 10 20
--
cgit v0.9.1
