From 9ab2aa5dda8629614f63443e965585949ca780fb Mon Sep 17 00:00:00 2001
From: Andreas Schneider <asn@cryptomilk.org>
Date: Thu, 12 Feb 2015 16:47:00 +0000
Subject: WIP: Fix VoIP

---
diff --git a/configs/audio/mixer_paths.xml b/configs/audio/mixer_paths.xml
index 23196f5..ccaf316 100644
--- a/configs/audio/mixer_paths.xml
+++ b/configs/audio/mixer_paths.xml
@@ -269,6 +269,17 @@
         <ctl name="HPOUT3R Input 3" value="ISRC2INT1" />
     </path>
 
+    <path name="scenario-earpiece-loopback">
+        <ctl name="ASRC RATE 1" value="SYNCCLK rate 3" />
+        <ctl name="ISRC2INT1 Input" value="ASRC2L" />
+        <ctl name="LHPF3 Input 1" value="None" />
+        <ctl name="LHPF3 Input 2" value="None" />
+        <ctl name="HPOUT3L Input 3" value="ISRC2INT1" />
+        <ctl name="HPOUT3R Input 3" value="ISRC2INT1" />
+        <ctl name="HPOUT3L Input 1" value="AIF1RX1" />
+        <ctl name="HPOUT3R Input 1" value="AIF1RX2" />
+    </path>
+
     <!-- ### Volume ### -->
 
     <path name="volume-earpiece-default">
@@ -724,6 +735,28 @@
         <ctl name="AIF2TX2 Input 1" value="ASRC1R" />
     </path>
 
+    <path name="scenario-builtin-mic-earpiece-communication">
+        <ctl name="ASRC RATE 1" value="SYNCCLK rate 1" />
+        <ctl name="AIF1TX1 Input 3" value="None" />
+        <ctl name="AIF1TX2 Input 3" value="None" />
+        <ctl name="LHPF1 Input 1" value="IN1L" />
+        <ctl name="ASRC1L Input" value="LHPF1" />
+        <ctl name="ASRC1R Input" value="LHPF1" />
+        <ctl name="AIF2TX1 Input 1" value="ASRC1L" />
+        <ctl name="AIF2TX2 Input 1" value="ASRC1R" />
+    </path>
+
+    <path name="scenario-builtin-mic-speaker-communication">
+        <ctl name="ASRC RATE 1" value="SYNCCLK rate 1" />
+        <ctl name="AIF1TX1 Input 3" value="None" />
+        <ctl name="AIF1TX2 Input 3" value="None" />
+        <ctl name="LHPF1 Input 1" value="IN1L" />
+        <ctl name="ASRC1L Input" value="LHPF2" />
+        <ctl name="ASRC1R Input" value="LHPF2" />
+        <ctl name="AIF2TX1 Input 1" value="ASRC1L" />
+        <ctl name="AIF2TX2 Input 1" value="ASRC1R" />
+    </path>
+
     <path name="scenario-builtin-mic-earpiece-incall-nb">
         <ctl name="Sample Rate 2" value="8kHz" />
         <ctl name="ASRC RATE 1" value="SYNCCLK rate 3" />
@@ -1274,7 +1307,7 @@
 
     <path name="communication-speaker">
         <path name="device-speaker" />
-        <path name="verb-default" />
+        <path name="verb-incall" />
 
         <path name="scenario-speaker-default" />
         <path name="volume-speaker-default" />
@@ -1282,15 +1315,15 @@
 
     <path name="communication-earpiece">
         <path name="device-earpiece" />
-        <path name="verb-default" />
+        <path name="verb-incall" />
 
-        <path name="scenario-earpiece-default" />
+        <path name="scenario-earpiece-loopback" />
         <path name="volume-earpiece-default" />
     </path>
 
     <path name="communication-headphones">
         <path name="device-headphones" />
-        <path name="verb-default" />
+        <path name="verb-incall" />
 
         <path name="scenario-headphones-default" />
         <path name="volume-headphones-default" />
@@ -1426,10 +1459,19 @@
         <path name="channel-left" />
     </path>
 
-    <path name="communication-main-mic">
+    <path name="communication-earpiece-main-mic">
         <path name="device-builtin-mic" />
 
-        <path name="scenario-builtin-mic-default" />
+        <path name="scenario-builtin-mic-earpiece-communication" />
+        <path name="volume-builtin-mic-default" />
+
+        <path name="channel-left" />
+    </path>
+
+    <path name="communication-speaker-main-mic">
+        <path name="device-builtin-mic" />
+
+        <path name="scenario-builtin-mic-speaker-communication" />
         <path name="volume-builtin-mic-default" />
 
         <path name="channel-left" />
diff --git a/hal/audio/audio_hw.c b/hal/audio/audio_hw.c
index 526c00e..b49a10b 100644
--- a/hal/audio/audio_hw.c
+++ b/hal/audio/audio_hw.c
@@ -298,14 +298,18 @@ static int get_input_source_id(audio_source_t source, bool wb_amr)
     case AUDIO_SOURCE_DEFAULT:
         return IN_SOURCE_NONE;
     case AUDIO_SOURCE_MIC:
+        ALOGV("%s: AUDIO_SOURCE_MIC\n", __func__);
         return IN_SOURCE_MIC;
     case AUDIO_SOURCE_CAMCORDER:
         return IN_SOURCE_CAMCORDER;
     case AUDIO_SOURCE_VOICE_RECOGNITION:
+        ALOGV("%s: IN_SOURCE_VOICE_RECOGNITION\n", __func__);
         return IN_SOURCE_VOICE_RECOGNITION;
     case AUDIO_SOURCE_VOICE_COMMUNICATION:
+        ALOGV("%s: AUDIO_SOURCE_VOICE_COMMUNICATION\n", __func__);
         return IN_SOURCE_VOICE_COMMUNICATION;
     case AUDIO_SOURCE_VOICE_CALL:
+        ALOGV("%s: AUDIO_SOURCE_VOICE_CALL:\n", __func__);
         if (wb_amr) {
             return IN_SOURCE_VOICE_CALL_WB;
         }
diff --git a/hal/audio/routing.h b/hal/audio/routing.h
index 2765efa..c416272 100644
--- a/hal/audio/routing.h
+++ b/hal/audio/routing.h
@@ -179,21 +179,21 @@ const struct route_config voice_rec_headset = {
 
 const struct route_config communication_speaker = {
     "communication-speaker",
-    "communication-main-mic",
+    "communication-speaker-main-mic",
     { ES325_PRESET_VOIP_HANDHELD,
       ES325_PRESET_VOIP_DESKTOP }
 };
 
 const struct route_config communication_earpiece = {
     "communication-earpiece",
-    "communication-main-mic",
+    "communication-earpiece-main-mic",
     { ES325_PRESET_OFF,
       ES325_PRESET_OFF }
 };
 
 const struct route_config communication_headphones = {
     "communication-headphones",
-    "communication-main-mic",
+    "communication-earpiece-main-mic",
     { ES325_PRESET_VOIP_HEADPHONES,
       ES325_PRESET_VOIP_HP_DESKTOP}
 };
--
cgit v0.9.1
